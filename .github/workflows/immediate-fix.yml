name: Immediate Registry Fix

on:
  # Disabled automatic triggers - only run manually when needed
  # push:
  #   branches: [dev]
  workflow_dispatch:

jobs:
  fix-registry:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup DigitalOcean CLI
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_ACCESS_TOKEN }}

      - name: Fix Registry Credentials
        run: |
          echo "üîß Fixing DigitalOcean Container Registry Authentication"

          # Check if registry exists
          echo "üîç Checking registry..."
          if ! doctl registry get >/dev/null 2>&1; then
            echo "‚ùå No registry found. Creating one..."
            doctl registry create qylon --region nyc3
            echo "‚úÖ Registry created successfully!"
            sleep 30  # Wait for registry to be ready
          else
            echo "‚úÖ Registry exists"
          fi

          # Get registry credentials
          echo "üîë Getting registry credentials..."
          CREDENTIALS=$(doctl registry docker-config 2>/dev/null)

          if [ -n "$CREDENTIALS" ]; then
            echo "‚úÖ Got registry credentials!"

            # Extract username and password from docker config
            USERNAME=$(echo "$CREDENTIALS" | grep -o '"username":"[^"]*"' | cut -d'"' -f4)
            PASSWORD=$(echo "$CREDENTIALS" | grep -o '"password":"[^"]*"' | cut -d'"' -f4)

            if [ -n "$USERNAME" ] && [ -n "$PASSWORD" ]; then
              echo "üîÑ Updating GitHub secrets..."
              gh secret set DO_REGISTRY_USERNAME --body "$USERNAME"
              gh secret set DO_REGISTRY_PASSWORD --body "$PASSWORD"
              echo "‚úÖ GitHub secrets updated!"

              # Trigger deployment
              echo "üöÄ Triggering deployment..."
              if [ -n "${{ secrets.DO_APP_ID }}" ]; then
                doctl apps create-deployment "${{ secrets.DO_APP_ID }}" --force-rebuild
                echo "‚úÖ Deployment triggered!"
              else
                echo "‚ö†Ô∏è No DO_APP_ID found. Please create a DigitalOcean app first."
              fi
            else
              echo "‚ùå Failed to extract credentials"
              exit 1
            fi
          else
            echo "‚ùå Failed to get registry credentials"
            exit 1
          fi

      - name: Show Results
        run: |
          echo "üéØ Registry authentication fix completed!"
          echo "üîó Monitor deployment at:"
          echo "   DigitalOcean: https://cloud.digitalocean.com/apps"
          echo "   GitHub Actions: https://github.com/KD-Squares/qylon/actions"
